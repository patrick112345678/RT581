# TP-NWK-BV-02 (ZigBee Document 07-5035-07)

# gZC 
#    PAN ID = 0x1aaa    
#    0x0000
# Coordinator external address: aa:aa:aa:aa:aa:aa:aa:aa
# DUT ZR1
#    00:00:00:01:00:00:00:00

# (start gZC)
wpan.cmd, Beacon Request

# >>> Test procedure

# 1 DUT ZR performs a start-up.
# 2 Based on existing policy, DUT ZR performs NWK Join. Join
# to ExtendedPANId=0xaaaaaaaaaaaaaaaa.
# 2.1) ZR DUT shall issue a MLME_Beacon_Request MAC command frame.
wpan.cmd, Beacon Request

# 2.2) Based on the active scan result, ZR DUT shall complete the MAC association
# sequence.
# 2.3) gZC is able to receive the association request (places the ZR 64-bit address in
# its neighbor table).
wpan.frame_type, Beacon, zbee_beacon.ext_panid, aa:aa:aa:aa:aa:aa:aa:aa, wpan.src_pan, 0x1aaa, wpan.src16, 0x00000000, wpan.assoc_permit, True
wpan.cmd, Association Request, wpan.src64, 00:00:00:01:00:00:00:00, wpan.dst_pan, 0x1aaa
wpan.cmd, Association Response, wpan.src64, aa:aa:aa:aa:aa:aa:aa:aa, wpan.dst64, 00:00:00:01:00:00:00:00, wpan.dst_pan, 0x1aaa, wpan.assoc.status, 0x00000000, delta_time, -2
zbee_aps.zdp_cluster, Device Announcement, zbee_nwk.dst, 0x0000fffd, wpan.dst_pan, 0x1aaa, zbee_zdp.ext_addr, 00:00:00:01:00:00:00:00

# 3 DUT ZR performs a NWK LEAVE (self leave, address=NULL, rejoin=FALSE).
# 3.4) ZR shall issue a self- induced NWK LEAVE command frame to gZC, with
# the IEEE 64-bit address set to itself, with reason = 0x02.
zbee_nwk.cmd.id, Leave, wpan.src64, 00:00:00:01:00:00:00:00, zbee_nwk.src64, 00:00:00:01:00:00:00:00, zbee_nwk.cmd.leave.children, False

# 4 DUT ZR shall issue a Test Buffer Request to gZC.
# 4.5) ZR returns error on attempting to issue the Test Buffer Request.
zbee_aps.t2.cluster, Buffer Test Request, wpan.src64, 00:00:00:01:00:00:00:00, parallel, y, exclude, y

# 5 Based on existing policy, DUT ZR performs NWK Join.
wpan.cmd, Beacon Request
wpan.frame_type, Beacon, zbee_beacon.ext_panid, aa:aa:aa:aa:aa:aa:aa:aa, wpan.src_pan, 0x1aaa, wpan.src16, 0x00000000, wpan.assoc_permit, True
wpan.cmd, Association Request, wpan.src64, 00:00:00:01:00:00:00:00, wpan.dst_pan, 0x1aaa
wpan.cmd, Association Response, wpan.src64, aa:aa:aa:aa:aa:aa:aa:aa, wpan.dst64, 00:00:00:01:00:00:00:00, wpan.dst_pan, 0x1aaa, wpan.assoc.status, 0x00000000, delta_time, -2
zbee_aps.zdp_cluster, Device Announcement, zbee_nwk.dst, 0x0000fffd, wpan.dst_pan, 0x1aaa, zbee_zdp.ext_addr, 00:00:00:01:00:00:00:00

# 5.6) After ZR joins the network anew, gZC issues a NWK LEAVE to ZR. ZR
# shall not have the gZC as its coordinator.
# 6 gZC performs a LEAVE, where NLME-LEAVE.request(DeviceAddress=IEEE of ZR, rejoin=FALSE;
# remove children=FALSE); For ZigBee Pro, gZC sends Mgmt_Leave.request with DevAddr=all zero, DstAddr=ZR,
# rejoin=FALSE, remove children=FALSE.
zbee_nwk.cmd.id, Leave, zbee_nwk.src64, aa:aa:aa:aa:aa:aa:aa:aa, zbee_nwk.dst64, 00:00:00:01:00:00:00:00, zbee_nwk.cmd.leave.children, False, zbee_nwk.cmd.leave.rejoin, False, zbee_nwk.cmd.leave.request, True

# 7 DUT ZR shall issue a Test Buffer Request to ZC.
# 7.7) ZR returns error on attempting to issue the Test Buffer Request.
# (4.5 check will work)