# TP-PRO-BV-11 (ZigBee Document 07-5035-07)

# gZC address (wpan.src64): aa:aa:aa:aa:aa:aa:aa:aa
# gZC short address (): 0x0000
# DUT ZR2 address (wpan.src64): 00:00:00:02:00:00:00:00
# gZR3 address (wpan.src64): 00:00:00:03:00:00:00:00
# gZR4 address (wpan.src64): 00:00:00:04:00:00:00:00


# >>> Initial Conditions
# (Start gZC)
wpan.cmd, Beacon Request

# DUT ZR2 joins PAN with gZC.
wpan.cmd, Beacon Request
wpan, Beacon, zbee_beacon.ext_panid, aa:aa:aa:aa:aa:aa:aa:aa, wpan.assoc_permit, True
wpan.cmd, Association Request, wpan.src64, 00:00:00:02:00:00:00:00
wpan.cmd, Association Response, wpan.src64, aa:aa:aa:aa:aa:aa:aa:aa, wpan.dst64, 00:00:00:02:00:00:00:00, wpan.assoc.status, 0x00000000, delta_time, -2
zbee_aps.zdp_cluster, Device Announcement, zbee_zdp.ext_addr, 00:00:00:02:00:00:00:00

# gZR3 joins PAN with DUT ZR2.
wpan.cmd, Beacon Request
wpan, Beacon, zbee_beacon.ext_panid, aa:aa:aa:aa:aa:aa:aa:aa, wpan.src64, 00:00:00:02:00:00:00:00, wpan.assoc_permit, True
wpan.cmd, Association Request, wpan.src64, 00:00:00:03:00:00:00:00
wpan.cmd, Association Response, wpan.src64, 00:00:00:02:00:00:00:00, wpan.dst64, 00:00:00:03:00:00:00:00, wpan.assoc.status, 0x00000000, delta_time, -2
zbee_aps.zdp_cluster, Device Announcement, zbee_zdp.ext_addr, 00:00:00:03:00:00:00:00

# gZR4 joins PAN with DUT ZR3.
wpan.cmd, Beacon Request
wpan, Beacon, zbee_beacon.ext_panid, aa:aa:aa:aa:aa:aa:aa:aa, wpan.src64, 00:00:00:03:00:00:00:00, wpan.assoc_permit, True
wpan.cmd, Association Request, wpan.src64, 00:00:00:04:00:00:00:00
wpan.cmd, Association Response, wpan.src64, 00:00:00:03:00:00:00:00, wpan.dst64, 00:00:00:04:00:00:00:00, wpan.assoc.status, 0x00000000, delta_time, -2
zbee_aps.zdp_cluster, Device Announcement, zbee_zdp.ext_addr, 00:00:00:04:00:00:00:00

# 2 Register end point of 0xf0 and 0x01 in gZC, DUT ZR2, gZR3 and gZR4.
# 3 gZC initiated NLME-ROUTE DISCOVERY.Request
# Dst Addr mode =0x00 - No destination address
# DstAddr=0xFFF9
# Radius=0x03 - (may be assigned to be network broadcast radius)
# NoRouteCache=0x0.
# (We use another method of discovering)
zbee_nwk.cmd.id, Route Request, wpan.src64, 00:00:00:04:00:00:00:00, zbee_nwk.ext_dst, False, zbee_nwk.dst, 0xfffc, zbee_nwk.cmd.route.dest, 0x0000

# >>> Test Procedure

# 1 Hard reset gZR3
# 2 gZC issues the Transmit count packet to gZR4.
# Packet length=0x0A
# Dst address mode=0x02
# Dst address=gZR4 address
# Dst end point=0xF0
# Source endpoint=0x01
# No of packets=0x1
# Interval=1sec
# Tx option=0x00
# 2.1) gZC shall initiate a transmit count packet to gZR4. gZC shall unicast the
# data to DUT ZR2, as updated in the source routing table.
# 2.2) gZC over the air packet, the relay count subfield of the source route
# subframe shall have the value of two.
# 2.3) gZC over the air packet, the relay index subfield of the source route
# subframe shall have the value of one.
# 2.4) gZC over the air packet, the relay list subfield of the source route
# subframe shall have the address in the order of g ZR3, DUT ZR2
# 2.5) gZC over the air packet, the network destination address shall have the
# address of gZR4.
zbee_aps.t2.cluster, Transmit Counted Packets, zbee_nwk.src64, aa:aa:aa:aa:aa:aa:aa:aa, zbee_nwk.dst64, 00:00:00:04:00:00:00:00, wpan.src64, aa:aa:aa:aa:aa:aa:aa:aa, wpan.dst64, 00:00:00:02:00:00:00:00, zbee_nwk.src_route, True, zbee_nwk.relay.count, 02, zbee_nwk.relay.index, 01

# 2.6) DUT ZR2 over the air packet, the relay count subfield of the source route
# subframe shall have the value of two.
# 2.7) DUT ZR2 over the air packet, the relay index subfield of the source route
# subframe shall have the value of zero.
# 2.8) DUT ZR2 shall retry for three times to route the data (as gZR3 as hard-
# reset)
zbee_aps.t2.cluster, Transmit Counted Packets, zbee_nwk.src64, aa:aa:aa:aa:aa:aa:aa:aa, zbee_nwk.dst64, 00:00:00:04:00:00:00:00, wpan.src64, 00:00:00:02:00:00:00:00, wpan.dst64, 00:00:00:03:00:00:00:00, zbee_nwk.src_route, True, zbee_nwk.relay.count, 02, zbee_nwk.relay.index, 00, count, 4

# 2.9) On failure of this data transmission, DUT ZR2 shall issue Network Status
# command packet with the code (0x0B-Source route failure) to gZC
# concentrator.
zbee_nwk.cmd.id, Network Status, zbee_nwk.cmd.status, Source Route Failure, wpan.src64, 00:00:00:02:00:00:00:00, wpan.dst64, aa:aa:aa:aa:aa:aa:aa:aa