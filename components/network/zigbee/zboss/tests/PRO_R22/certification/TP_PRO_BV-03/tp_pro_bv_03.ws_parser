# TP-PRO-BV-03 (ZigBee Document 07-5035-07)

# DUT ZC address (wpan.src64): aa:aa:aa:aa:aa:aa:aa:aa
# DUT ZC short address (): 0x0000
# DUT ZR1 address (wpan.src64): 00:00:00:01:00:00:00:00
# gZED address (wpan.src64): 00:00:00:00:00:00:00:01
# PAN id (wpan.dst_pan): -

# >>> Initial Conditions
# 1 Reset DUT ZC
wpan.cmd, Beacon Request
# 2 Set DUT ZC, under target stack profile, DUT ZC
# as co-coordinator starts a PAN with a random value
# (within the range 0x1 to 0x3FFF)
# 3 DUT ZR joins DUT ZC.
wpan.cmd, Beacon Request
wpan, Beacon, zbee_beacon.ext_panid, aa:aa:aa:aa:aa:aa:aa:aa, wpan.src16, 0x00000000, wpan.assoc_permit, True
wpan.cmd, Association Request, wpan.src64, 00:00:00:01:00:00:00:00
wpan.cmd, Association Response, wpan.src64, aa:aa:aa:aa:aa:aa:aa:aa, wpan.dst64, 00:00:00:01:00:00:00:00, wpan.assoc.status, 0x00000000, delta_time, -2
zbee_aps.zdp_cluster, Device Announcement, zbee_zdp.ext_addr, 00:00:00:01:00:00:00:00

# gZED joins PAN at DUT.
wpan.cmd, Beacon Request
wpan, Beacon, zbee_beacon.ext_panid, aa:aa:aa:aa:aa:aa:aa:aa, !wpan.src16, 0x00000000, wpan.assoc_permit, True
wpan.cmd, Association Request, wpan.src64, 00:00:00:00:00:00:00:01
wpan.cmd, Association Response, wpan.src64, 00:00:00:01:00:00:00:00, wpan.dst64, 00:00:00:00:00:00:00:01, wpan.assoc.status, 0x00000000, delta_time, -2
zbee_aps.zdp_cluster, Device Announcement, zbee_zdp.ext_addr, 00:00:00:00:00:00:00:01


# >>> Test procedure
# 1. Hard reset the DUT ZR.
# 1.1) After DUT ZR reset, gZED attempts to transmit data request packet
# to DUT ZR; upon failure (or based on "No Ack", gZED initiates rejoin
# procedure by performing an active scan.
wpan.cmd, Data Request, wpan.src64, 00:00:00:00:00:00:00:01, !wpan.dst16, 0x00000000, delta_time, -7.5, count, -1, parallel, y
wpan.cmd, Beacon Request

# 2) DUT ZC transmits a beacon indicating available device capacity
wpan, Beacon, zbee_beacon.ext_panid, aa:aa:aa:aa:aa:aa:aa:aa, wpan.src16, 0x00000000, wpan.assoc_permit, True

# 3) gZED unicasts a Rejoin Request command to DUT ZC
zbee_nwk.cmd.id, Rejoin Request, zbee_nwk.src64, 00:00:00:00:00:00:00:01

# 4) DUT ZC issues a rejoin response to gZED
zbee_nwk.cmd.id, Rejoin Response, zbee_nwk.src64, aa:aa:aa:aa:aa:aa:aa:aa, zbee_nwk.cmd.rejoin_status, 0x00000000

# 5) gZED rejoins the network.
zbee_aps.zdp_cluster, Device Announcement, zbee_zdp.ext_addr, 00:00:00:00:00:00:00:01
# 6) DUT ZC assigns the same short address to gZED. (ZED does not
# change addresses on rejoin). gZED issues Device Announce in its
# new location but with same short address.
# >>> TODO: Implement this check somehow.
# 7) gZED polls DUT ZC and receives acknowledgement with interval as
# defined by stack profile (say 7.5 seconds).
wpan.cmd, Data Request, wpan.src64, 00:00:00:00:00:00:00:01, wpan.dst16, 0x00000000, delta_time, -7.5, count, -1, parallel, y
